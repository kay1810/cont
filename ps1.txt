function Get-GitHubFileContent {
    param (
        [string]$Username,
        [string]$Repository,
        [string]$AccessToken,
        [string]$FilePath,
        [string]$BranchName
    )

    $apiUrl = "https://api.github.com/repos/$Username/$Repository/contents/$FilePath?ref=$BranchName"

    try {
        $response = Invoke-RestMethod -Uri $apiUrl -Headers @{
            Authorization = "token $AccessToken"
            Accept = "application/vnd.github.v3+json"
        }

        return $response
    } catch {
        Write-Error "Failed to retrieve file content: $_"
    }
}

function Update-GitHubFileContent {
    param (
        [string]$Username,
        [string]$Repository,
        [string]$AccessToken,
        [string]$FilePath,
        [string]$BranchName,
        [string]$NewContent,
        [string]$Sha
    )

    $fileContentBase64 = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($NewContent))

    $apiUrl = "https://api.github.com/repos/$Username/$Repository/contents/$FilePath"

    $body = @{
        message = "Update $FilePath"
        content = $fileContentBase64
        branch = $BranchName
        sha = $Sha
    } | ConvertTo-Json

    try {
        $response = Invoke-RestMethod -Uri $apiUrl -Method PUT -Headers @{
            Authorization = "token $AccessToken"
            Accept = "application/vnd.github.v3+json"
        } -Body $body

        return $response
    } catch {
        Write-Error "Failed to update file content: $_"
    }
}

# Set your GitHub credentials and repository information
$githubUsername = "your_username"
$repositoryName = "your_repository"
$accessToken = "your_personal_access_token"
$branchName = "main"
$csvFilePath = "Server_Details.csv"
$jsonFilePath = "Server_Details_Json.json"

# Function to convert CSV to JSON
function Convert-CsvToJson {
    param (
        [string]$CsvFilePath
    )

    try {
        $csvContent = Import-Csv -Path $CsvFilePath
        $jsonContent = $csvContent | ConvertTo-Json -Depth 100

        return $jsonContent
    } catch {
        Write-Error "Failed to convert CSV to JSON: $_"
    }
}

# Get the content of the CSV file from GitHub
$csvFileContent = Get-GitHubFileContent -Username $githubUsername -Repository $repositoryName -AccessToken $accessToken -FilePath $csvFilePath -BranchName $branchName

if ($csvFileContent) {
    # Convert CSV content to JSON
    $jsonContent = Convert-CsvToJson -CsvFilePath $csvFilePath

    # Get the SHA of the JSON file if it exists
    $jsonFileContent = Get-GitHubFileContent -Username $githubUsername -Repository $repositoryName -AccessToken $accessToken -FilePath $jsonFilePath -BranchName $branchName

    $sha = $null
    if ($jsonFileContent) {
        $sha = $jsonFileContent.sha
    }

    # Update the JSON file on GitHub
    Update-GitHubFileContent -Username $githubUsername -Repository $repositoryName -AccessToken $accessToken -FilePath $jsonFilePath -BranchName $branchName -NewContent $jsonContent -Sha $sha
}
